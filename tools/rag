#!/bin/bash
# Codebase RAG System - Easy command-line interface

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DB_PATH="$REPO_ROOT/codebase_rag.db"
PYTHON="${PYTHON:-python3}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_help() {
    cat << EOF
${BLUE}üîç MyWant Codebase RAG System${NC}

${GREEN}Usage:${NC}
  $0 [command] [options]

${GREEN}Commands:${NC}
  index                Build/rebuild the code index
  search <query>      Search the codebase
  arch                Show architecture overview
  interactive         Start interactive search mode (default)
  setup               Install dependencies
  reset               Delete and rebuild the index
  help                Show this help message

${GREEN}Examples:${NC}
  # Index the codebase
  $0 index

  # Search for something
  $0 search "Want execution"
  $0 search "func:GetOutputChannel"
  $0 search "struct:ChainBuilder"

  # Show architecture
  $0 arch

  # Interactive mode (default)
  $0

${GREEN}Search Query Syntax:${NC}
  - Plain text:    search keywords
  - func:name     search functions
  - struct:name   search structs
  - file:name     search files

${GREEN}Database:${NC}
  Location: $DB_PATH
  Size: $([ -f "$DB_PATH" ] && du -h "$DB_PATH" | cut -f1 || echo "not built yet")
  Status: $([ -f "$DB_PATH" ] && echo "Ready" || echo "Not indexed")

EOF
}

setup_dependencies() {
    echo -e "${BLUE}üì¶ Setting up RAG dependencies...${NC}"

    # Check if pip is available
    if ! command -v pip &> /dev/null && ! command -v pip3 &> /dev/null; then
        echo -e "${RED}‚ùå pip not found. Please install Python 3.7+${NC}"
        exit 1
    fi

    # Try to install requirements
    if [ -f "$SCRIPT_DIR/requirements-rag.txt" ]; then
        echo -e "${YELLOW}Installing from requirements-rag.txt...${NC}"
        pip install -q -r "$SCRIPT_DIR/requirements-rag.txt" || \
        pip3 install -q -r "$SCRIPT_DIR/requirements-rag.txt"
        echo -e "${GREEN}‚úÖ Dependencies installed${NC}"
    else
        echo -e "${YELLOW}Installing minimal dependencies...${NC}"
        pip install -q sentence-transformers 2>/dev/null || \
        pip3 install -q sentence-transformers 2>/dev/null || \
        echo -e "${YELLOW}‚ö†Ô∏è  Could not install sentence-transformers, using keyword search${NC}"
        echo -e "${GREEN}‚úÖ Setup complete${NC}"
    fi
}

build_index() {
    echo -e "${BLUE}üìù Building code index...${NC}"
    echo -e "${YELLOW}This may take a minute...${NC}\n"

    cd "$REPO_ROOT"
    $PYTHON "$SCRIPT_DIR/codebase_rag.py" index

    echo -e "\n${GREEN}‚úÖ Index built successfully!${NC}"
    echo -e "${BLUE}Database location: $DB_PATH${NC}"
    echo -e "${BLUE}Database size: $(du -h "$DB_PATH" | cut -f1)${NC}"
}

search_codebase() {
    local query="$1"

    if [ -z "$query" ]; then
        echo -e "${RED}‚ùå Please provide a search query${NC}"
        echo -e "${YELLOW}Example: $0 search \"Want execution\"${NC}"
        exit 1
    fi

    if [ ! -f "$DB_PATH" ]; then
        echo -e "${RED}‚ùå Index not built yet. Run: $0 index${NC}"
        exit 1
    fi

    cd "$REPO_ROOT"
    $PYTHON << 'PYTHON_EOF'
import sys
sys.path.insert(0, 'tools')
from codebase_rag import CodebaseRAG

query = sys.argv[1] if len(sys.argv) > 1 else ""
if not query:
    print("‚ùå No query provided")
    sys.exit(1)

rag = CodebaseRAG('codebase_rag.db')
results = rag.search(query, limit=15)

if results:
    print(f"\n‚úÖ Found {len(results)} results:\n")
    for i, result in enumerate(results, 1):
        print(f"{i}. {result['name']} ({result['entity_type']})")
        print(f"   üìÅ {result['file_path']}:{result['line_number']}")
        print(f"   üìù {result['summary']}")
        if result['signature'] and len(result['signature']) > 0:
            sig = result['signature'][:100].strip()
            print(f"   ‚öôÔ∏è  {sig}...")
        print()
else:
    print("‚ùå No results found.")

rag.close()
PYTHON_EOF
}

show_architecture() {
    if [ ! -f "$DB_PATH" ]; then
        echo -e "${RED}‚ùå Index not built yet. Run: $0 index${NC}"
        exit 1
    fi

    cd "$REPO_ROOT"
    $PYTHON << 'PYTHON_EOF'
import sys
sys.path.insert(0, 'tools')
from codebase_rag import CodebaseRAG

rag = CodebaseRAG('codebase_rag.db')
overview = rag.get_architecture_overview()

print("\nüìê Architecture Overview")
print("=" * 60)
print(f"Total Entities: {overview['total_entities']}\n")

print("Entity Types:")
for etype, count in sorted(overview['by_type'].items()):
    print(f"  ‚Ä¢ {etype}: {count}")

print("\nPackages/Directories:")
for pkg, count in sorted(overview['by_package'].items()):
    print(f"  ‚Ä¢ {pkg}: {count} entities")

print("\nTop Files by Entity Count:")
for i, file_info in enumerate(overview['top_files'][:10], 1):
    print(f"  {i}. {file_info['file']}: {file_info['count']} entities")

print()
rag.close()
PYTHON_EOF
}

interactive_mode() {
    if [ ! -f "$DB_PATH" ]; then
        echo -e "${YELLOW}Index not found. Building now...${NC}\n"
        build_index
        echo
    fi

    cd "$REPO_ROOT"
    $PYTHON "$SCRIPT_DIR/codebase_rag.py"
}

reset_index() {
    if [ ! -f "$DB_PATH" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No index to delete${NC}"
        return
    fi

    echo -e "${YELLOW}üóëÔ∏è  Deleting index at: $DB_PATH${NC}"
    rm -f "$DB_PATH"
    echo -e "${GREEN}‚úÖ Index deleted${NC}"

    echo -e "\n${BLUE}Rebuilding index...${NC}"
    build_index
}

# Main command handling
case "${1:-interactive}" in
    index)
        build_index
        ;;
    search)
        search_codebase "$2"
        ;;
    arch|architecture)
        show_architecture
        ;;
    interactive)
        interactive_mode
        ;;
    setup)
        setup_dependencies
        ;;
    reset)
        reset_index
        ;;
    help|--help|-h)
        print_help
        ;;
    *)
        print_help
        echo -e "${RED}Unknown command: $1${NC}"
        exit 1
        ;;
esac
